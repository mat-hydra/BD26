---
title: "**Raport Analityczny: Federacja Sportowa Chomików**"
author: "HYDRA"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: united
    toc: true
    toc_float: true
    number_sections: true
  pdf_document:
    toc: true
    number_sections: true
  word_document:
    toc: true
    number_sections: true
---

\newpage

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse) 
library(DBI)       
library(RMariaDB)  
library(knitr)    
library(lubridate) 
library(ggplot2)
library(ggrepel)

con <- dbConnect(RMariaDB::MariaDB(), 
                 dbname = "mwfc", 
                 user = "root", 
                 password = "", 
                 host = "localhost")

get_orange_palette <- function(n) {
  if (is.null(n) || length(n) == 0 || n == 0) return(character(0))
  colorRampPalette(c("orange", "darkorange", "chocolate", "saddlebrown", "#3d1c02"))(n)}

```

# **Wstęp**
Niniejszy raport stanowi analizę danych Międzynarodowej Federacji Wyścigów Chomików. Celem dokumentu jest ocena wyników sportowych, kondycji finansowej federacji oraz analiza trendów w chomiczym sporcie na podstawie zgromadzonych **`r dbGetQuery(con, "SELECT COUNT(*) as n FROM chomiki")$n` ** rekordów chomików, i **`r dbGetQuery(con, "SELECT COUNT(*) as n FROM zawody")$n`** rekordów zawodów.

<br><br>


# **Profil Zawodnika i Wyniki Sportowe**

## **Analiza Mistrzów i Wyników Sportowych**

```{sql connection=con, output.var = "mistrze_wyniki"}
SELECT konkurencje.kategorie as kategoria, chomiki.imie as imie  , rasa.nazwa as rasa, COUNT(przebieg.zwyciezca) as liczba_wygranych FROM przebieg
JOIN chomiki ON przebieg.id_chomika = chomiki.id_chomika
JOIN konkurencje ON przebieg.id_konkurencji = konkurencje.id_konkurencji
JOIN rasa ON chomiki.id_rasy = rasa.id_rasy
WHERE przebieg.zwyciezca = 1
GROUP BY kategoria, imie, rasa
ORDER BY kategoria, liczba_wygranych ;
```

```{r wykres_mistrze_wyniki}
top_chomiki <- mistrze_wyniki %>% 
  group_by(kategoria) %>% 
  slice_max(liczba_wygranych, n = 3)

ggplot(top_chomiki, aes(x = reorder(imie, liczba_wygranych), y = liczba_wygranych)) +
  geom_col(fill= "orange",color = "black", width = 1) +
  coord_flip() + 
  facet_wrap(~kategoria, scales = "free_y") + 
  labs(x = "Imię chomika", y = "Liczba zwycięstw") +
  scale_y_continuous(breaks = function(x) seq(0, max(x), by = 1)) +
  theme_minimal(base_size = 13) +theme(legend.position = "none", )

```

W formule Ch mistrzem jest **`r mistrze_wyniki %>% filter(kategoria == "formula CH") %>% slice_max(liczba_wygranych) %>% pull(imie) %>% paste(collapse = ", ")`**, osiągając **`r mistrze_wyniki %>% filter(kategoria == "formula CH") %>% slice_max(liczba_wygranych) %>% pull(liczba_wygranych) %>% head(1)`** zwycięstw.

W formule sportów naturalnych mistrzem jest **`r mistrze_wyniki %>% filter(kategoria == "naturalna") %>% slice_max(liczba_wygranych) %>% pull(imie) %>% paste(collapse = ", ")`**, osiągając **`r mistrze_wyniki %>% filter(kategoria == "naturalna") %>% slice_max(liczba_wygranych) %>% pull(liczba_wygranych) %>% head(1)`** zwycięstw.



## **Szczyt Kariery i Wiek Zawodników**

```{sql connection=con, output.var = "zwyciestwa_wiek"}
SELECT chomiki.imie as imie, chomiki.data_urodzenia as data_urodzenia, zawody.termin as szczyt_kariery, 
TIMESTAMPDIFF(MONTH, chomiki.data_urodzenia, zawody.termin) as wiek_w_miesiacach, przebieg.zwyciezca as zwyciezca FROM przebieg 
JOIN chomiki  ON przebieg.id_chomika = chomiki.id_chomika
JOIN zawody  ON przebieg.id_zawodow = zawody.id_zawodow
WHERE zwyciezca = 1 ;
```



```{r wykres_zwyciestwa_wiek}
ggplot(zwyciestwa_wiek, aes(x = wiek_w_miesiacach)) +
  
  geom_bar(fill = "darkorange", color = "black", alpha = 0.9, width = 0.8) +
  scale_x_continuous(breaks = seq(0, 30, by = 2)) +
  labs(x = "Wiek chomika (w miesiącach)",y = "Łączna liczba zwycięstw",) +

  theme_minimal(base_size = 13) + 
  theme( axis.text = element_text(color = "black"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank() )
```



Statystyki wskazują, że szczyt formy jest zależny od wieku.
Najwięcej zwycięstw osiągają chomiki w wieku **`r zwyciestwa_wiek %>% count(wiek_w_miesiacach) %>% slice_max(n, n=1) %>% arrange(wiek_w_miesiacach) %>% pull(wiek_w_miesiacach) %>% paste(collapse=", ")`** miesięcy. Z kolei najmniej sukcesów na koncie mają zawodnicy w wieku **`r zwyciestwa_wiek %>% count(wiek_w_miesiacach) %>% slice_min(n, n=1) %>% arrange(wiek_w_miesiacach) %>% pull(wiek_w_miesiacach) %>% paste(collapse=", ")`** miesięcy.

## **Wpływ wagi na wyniki – czy lżejsze chomiki są szybsze?**

```{sql connection=con, output.var = "dane_o_wadze", echo=FALSE}
SELECT chomiki.imie, chomiki.waga, przebieg.czas FROM przebieg
JOIN chomiki ON przebieg.id_chomika = chomiki.id_chomika
WHERE chomiki.waga > 0 AND przebieg.czas > 0;
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(dane_o_wadze, aes(x = waga, y = czas)) +
geom_point(color = "orange", size = 3, alpha = 0.4) + 
geom_smooth(method = "lm", color = "darkblue", se = FALSE, size = 1) +
scale_x_continuous() + 
scale_y_continuous() +
labs(x = "Waga chomika (g)", y = "Czas przebiegu (s)") +
theme_minimal(base_size = 13) +
theme(axis.text = element_text(color = "black"), panel.grid.minor = element_blank() )
```


Niebieska linia na tym wykresie to linia trendu. Pokazuje ona ogólną zależność dla wszystkich zawodników, ignorując pojedyncze odstępstwa. Jeśli linia wznosi się do góry (↗), oznacza to, że im cięższy jest chomik, tym dłuższy czas osiąga (czyli cięższe chomiki są wolniejsze). Jeśli linia opada w dół (↘), oznacza to, że im cięższy jest chomik, tym krótszy czas osiąga (czyli cięższe chomiki są szybsze).Im bardziej stroma jest ta linia, tym silniejszy jest wpływ wagi na wynik biegu.


<br><br>

## **Jaka jest skala dopingu w chomiczym sporcie?**

```{sql connection=con, output.var = "dane_doping", echo=FALSE}
SELECT 
    IFNULL(s.nazwa, 'Czysty') as nazwa, 
    COUNT(k.id_chomika) as liczba_przypadkow
FROM kontrola_antydopingowa k
LEFT JOIN substancje_zakazane s ON k.id_substancji = s.id_substancji
GROUP BY nazwa;
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
liczba_kat_doping <- nrow(dane_doping)

ggplot(dane_doping, aes(x = nazwa, y = liczba_przypadkow, fill = nazwa)) +
geom_col(color = "black", size = 0.5, show.legend = FALSE) +
scale_fill_manual(values = get_orange_palette(liczba_kat_doping)) +
labs( x = "Status", y = "Liczba chomików") +theme_minimal(base_size = 13) 
```

W ramach dbałości o czystość sportu przeprowadzono łącznie **`r sum(dane_doping$liczba_przypadkow)`** kontroli.
Wyniki wykazały, że **`r sum(dane_doping$liczba_przypadkow[dane_doping$nazwa == "Czysty"])`** tetsów było negatywnych.
Odnotowano przypadki stosowania dopingu (**`r sum(dane_doping$liczba_przypadkow[dane_doping$nazwa != "Czysty"])`** przypadków).
Najczęściej wykrywaną substancją zakazaną była **`r dane_doping %>% filter(nazwa != "Czysty") %>% slice_max(liczba_przypadkow) %>% pull(nazwa) %>% paste(collapse = ", ")`**.


<br><br>


# **Zasięg i Rozwój Federacji**

## **Trendy i Popularność Sportu**
```{sql connection=con, output.var = "tre_pop"}
SELECT zawody.termin as data, COUNT(przebieg.id_przebiegu) as liczba_uczestnikow FROM zawody 
JOIN przebieg ON zawody.id_zawodow = przebieg.id_zawodow 
GROUP BY zawody.termin 
ORDER BY liczba_uczestnikow DESC ;

```



```{r wykres_tre_pop}
tre_pop$data <- as.Date(tre_pop$data)
tre_pop$liczba_uczestnikow <- as.numeric(tre_pop$liczba_uczestnikow)

ggplot(tre_pop, aes(x = data, y = liczba_uczestnikow)) +
  geom_line(color = "orange", size = 1.5) +
  geom_point(color = "darkorange", size = 3) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y", date_minor_breaks = "3 months" ) +
  scale_y_continuous(breaks = seq(min(tre_pop$liczba_uczestnikow), max(tre_pop$liczba_uczestnikow), by = 7)) +
  labs(x = "Data zawodów", y = "Liczba uczestników") +
  theme_minimal(base_size = 13) +
  theme(panel.grid.minor.x = element_line(color = "#ebebeb"), panel.grid.minor.y = element_blank() 
  )
```

Szczyt popularności chomiczego sportu przypadł na dzień **`r tre_pop %>% arrange(desc(liczba_uczestnikow)) %>% pull(data) %>% head(1)`**. W zawodach wzięła wówczas udział rekordowa liczba **`r max(tre_pop$liczba_uczestnikow)`** uczestników.

<br><br>


## **Gdzie chomiczy sport jest najpopularniejszy?**

```{sql connection=con, output.var = "dane_kraje", echo=FALSE}
SELECT k.nazwa AS kraj, 
COUNT(*) AS liczba_zawodow
FROM zawody z
JOIN miasta m ON z.id_miasta = m.id_miasta
JOIN kraje k ON m.id_kraju = k.id_kraju
GROUP BY k.nazwa;
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
liczba_krajow <- nrow(dane_kraje)

ggplot(dane_kraje, aes(x = kraj, y = liczba_zawodow, fill = kraj)) +
  geom_col(color = "black", size = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = get_orange_palette(liczba_krajow)) +
  labs(x = "Kraj", y = "Suma liczby zawodów") + 
  theme_minimal(base_size = 13) +
  theme( axis.text.x = element_text(angle = 45, hjust = 1, color = "black"),
    axis.text.y = element_text(color = "black"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank())
```

Liderem w organizowaniu zawodów jest **`r dane_kraje %>% slice_max(liczba_zawodow) %>% pull(kraj) %>% paste(collapse = ", ")`**, gdzie zorganizowano ( /po) **`r dane_kraje %>% slice_max(liczba_zawodow) %>% pull(liczba_zawodow) %>% head(1)`** oficjalnych zawodów.


# **Finanse i Partnerzy Biznesowi**

<br><br>


## **Kondycja Finansowa i Atrakcyjność Rynkowa**

### **Atrakcyjność Rynkowa: Portfolio Sponsorów**
```{sql connection=con, output.var = "fin_atr" }
SELECT sponsorzy.nazwa AS sponsor, COUNT(chomiki.id_chomika) AS liczba_chomikow, 
SUM(finanse.kwota) AS suma_wplat
FROM sponsorzy
JOIN chomiki ON sponsorzy.id_sponsora = chomiki.id_sponsora
JOIN finanse ON chomiki.id_chomika = finanse.id_chomika
WHERE finanse.id_typu = 1
GROUP BY sponsorzy.id_sponsora, sponsorzy.nazwa
ORDER BY suma_wplat DESC;
```

```{r wykres_fin_atr}
ggplot(fin_atr, aes(x = reorder(sponsor, -suma_wplat), y = suma_wplat)) +
  geom_bar(fill = "orange", color = "black", alpha = 0.9, width = 0.7, stat = "identity") +
  
  labs(x = "Sponsor", y = "Suma wpłat",) +
  theme_minimal(base_size = 13) + 
  theme( axis.text.x = element_text(angle = 45, hjust = 1, color = "black"),
    axis.text.y = element_text(color = "black"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank())

```

Strategicznym partnerem federacji jest firma **`r fin_atr %>% slice_max(suma_wplat) %>% pull(sponsor) %>% paste(collapse = ", ")`**, której łączny wkład finansowy wyniósł ( /po) **`r format(fin_atr %>% slice_max(suma_wplat) %>% pull(suma_wplat) %>% head(1), scientific = FALSE, big.mark = " ")`** PLN.Łącznie od wszystkich sponsorów pozyskano fundusze w wysokości **`r format(sum(fin_atr$suma_wplat), scientific = FALSE, big.mark = " ")`** PLN.


### **Atrakcyjność Rynkowa: Wydatki na Kadry**
```{sql connection=con, output.var = "fin_atr1" }

SELECT DATE_FORMAT(data_wyplaty, '%Y-%m') AS miesiac, SUM(kwota_zl) AS suma_wydatkow
FROM wyplaty
GROUP BY miesiac
ORDER BY miesiac;
```

```{r wykres_fin_atr1}

fin_atr1$miesiac <- as.Date(paste0(fin_atr1$miesiac, "-01"))

ggplot(fin_atr1, aes(x = miesiac, y = suma_wydatkow, group = 1)) +
  geom_area(fill = "darkorange", alpha = 0.5) +
  geom_line(color = "orange", size = 1.1) +
  geom_point(color = "darkorange", size = 2) +
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") +
  
  labs(x = "Rok oraz miesiąc", y = "Łączna kwota wypłat (PLN)") +
  theme_minimal(base_size = 13) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, color = "black"),
  axis.text.y = element_text(color = "black"),
  panel.grid.minor = element_blank())
```


Największe obciążenie budżetu odnotowano w miesiącu **`r fin_atr1 %>% arrange(desc(suma_wydatkow)) %>% pull(miesiac) %>% head(1)`**, kiedy to suma wypłat osiągnęła szczytowy poziom **`r format(max(fin_atr1$suma_wydatkow), scientific = FALSE, big.mark = " ")`** PLN.

<br><br>




## **Który sponsor ma pod opieką chomiki z największą liczbą zwycięstw.**

```{sql connection=con, output.var = "dane_sponsorzy", echo=FALSE}
SELECT 
s.nazwa AS sponsor, 
COUNT(*) AS liczba_zwyciestw
FROM sponsorzy s
JOIN chomiki c ON s.id_sponsora = c.id_sponsora
JOIN przebieg p ON c.id_chomika = p.id_chomika
WHERE p.czas = (SELECT MIN(czas) FROM przebieg p2 WHERE p2.id_zawodow = p.id_zawodow)
GROUP BY s.nazwa
ORDER BY liczba_zwyciestw DESC;
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
liczba_sponsorow <- nrow(dane_sponsorzy)

ggplot(dane_sponsorzy, aes(x = sponsor, y = liczba_zwyciestw, fill = sponsor)) +
  geom_col(color = "black", size = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = get_orange_palette(liczba_sponsorow)) +
  labs(x = "Sponsor", y = "Liczba wygranych") +
  theme_minimal(base_size = 13) +
  theme( axis.text.x = element_text(angle = 45, hjust = 1, color = "black"),
    axis.text.y = element_text(color = "black"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank())

```


Największą liczbą zwycięstw w historii mogą pochwalić się: **`r dane_sponsorzy %>% filter(liczba_zwyciestw == max(liczba_zwyciestw)) %>% pull(sponsor) %>% paste(collapse = ", ")`**. Sponsorzy ci doprowadzili swoich zawodników do podium ( /po) **`r max(dane_sponsorzy$liczba_zwyciestw)`** razy.
